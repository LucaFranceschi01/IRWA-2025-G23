{% extends "base.html" %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block header %}

<!-- Next tag loads Charts.js https://www.chartjs.org/docs/latest/ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.2/chart.min.js"
integrity="sha512-tMabqarPtykgDtdtSqCL3uLVM0gS1ZkUAVhRFu1vSEFgvB73niFQWJuvviDyBGBH22Lcau4rHB5p2K2T0Xvr6Q=="
crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js"></script> -->
<script src="https://pandameister.github.io/chartjs-chart-sunburst/docs/js/Chart.Sunburst.umd.js"></script>
{% endblock %}

{% block content %}
<div class="mb-3">
    <button onclick="history.back()" class="btn btn-outline-secondary">&larr; Back</button>
</div>

<div class="container-fluid">
    <h2 class="mb-4">Analytics Dashboard</h2>

    <!-- KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Total Sessions</div>
                <div class="card-body">
                    <h1 class="card-title">{{ kpis.total_sessions }}</h1>
                    <p class="card-text">Unique visits to the site</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">Total Searches</div>
                <div class="card-body">
                    <h1 class="card-title">{{ kpis.total_searches }}</h1>
                    <p class="card-text">Queries performed</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-header">Total Clicks</div>
                <div class="card-body">
                    <h1 class="card-title">{{ kpis.total_clicks }}</h1>
                    <p class="card-text">Document interactions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Avg Session Duration</div>
                <div class="card-body">
                    <h1 class="card-title">{{ kpis.avg_session_duration }} min</h1>
                    <p class="card-text">Average time spent on site</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card text-white bg-secondary mb-3">
                <div class="card-header">Avg Dwell Time</div>
                <div class="card-body">
                    <h1 class="card-title">{{ kpis.avg_dwell_time }} s</h1>
                    <p class="card-text">Average time reading documents</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card h-100">
                <div class="card-header">Daily Traffic</div>
                <div class="card-body">
                    <canvas id="dailyTrafficChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">Top Search Queries</div>
                <div class="card-body">
                    <canvas id="topQueriesChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">Top Search Methods</div>
                <div class="card-body">
                    <canvas id="searchMethodsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">Browser Distribution</div>
                <div class="card-body">
                    <canvas id="browserChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">OS Distribution</div>
                <div class="card-body">
                    <canvas id="osChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 4 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">Location Distribution</div>
                <div class="card-body">
                    <canvas id="countryChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">Location Distribution</div>
                <div class="card-body">
                    <canvas id="cityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
<!-- 
    <div class="row">
        <div class="card h-100" style="min-height: 800px; min-width: 100%;">
            <div class="card-header">User Locations</div>
            <div class="card-body">
                <canvas id="locationSunburst"></canvas>
            </div>
        </div>
    </div> -->

    <!-- Most Visited Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">Most Visited Documents</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Visits</th>
                                    <th>Avg Dwell Time (s)</th>
                                    <th>Avg Rank</th>
                                    <th>Doc ID</th>
                                    <th>Title</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in visited_docs %}
                                <tr>
                                    <td><span class="badge badge-primary">{{ doc.counter }}</span></td>
                                    <td>{{ doc.avg_dwell_time }}</td>
                                    <td>{{ doc.avg_rank }}</td>
                                    <td>{{ doc.doc_id }}</td>
                                    <td>{{ doc.title }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    // function convertTreeToFlatNodes(tree) {
    //     let nodes = [];
    //     let idCounter = 0;

    //     // Calculate total for root
    //     const totalValue = tree.children.reduce((sum, country) => {
    //         return sum + country.children.reduce((s, c) => s + c.value, 0);
    //     }, 0);

    //     // Root node
    //     nodes.push({
    //         id: idCounter,
    //         parentId: null,
    //         value: totalValue,
    //         name: "ROOT"
    //     });

    //     const rootId = idCounter;
    //     idCounter++;

    //     // Convert recursively
    //     tree.children.forEach(country => {
    //         const countryId = idCounter++;
    //         const countryTotal = country.children.reduce((s, c) => s + c.value, 0);

    //         // Country node
    //         nodes.push({
    //             id: countryId,
    //             parentId: rootId,
    //             value: countryTotal,
    //             name: country.name,
    //             color: country.color
    //         });

    //         // City nodes
    //         country.children.forEach(city => {
    //             const cityId = idCounter++;

    //             nodes.push({
    //                 id: cityId,
    //                 parentId: countryId,
    //                 value: city.value,
    //                 name: city.name,
    //                 color: city.color
    //             });
    //         });
    //     });

    //     return nodes;
    // }

    // // Build sunburst dataset
    // function buildSunburstData(data) {
    //     return {
    //         children: Object.entries(data).map(([country, cities]) => ({
    //             name: country,
    //             children: Object.entries(cities).map(([city, count], j) => ({
    //                 name: city,
    //                 value: count
    //             }))
    //         }))
    //     };
    // }

    // Prepare data from Flask
    const dailyTrafficData = JSON.parse('{{ daily_traffic | tojson }}');
    const topQueriesData = JSON.parse('{{ top_queries | tojson }}');
    const searchMethodsData = JSON.parse('{{ search_methods | default({}) | tojson }}');
    const browserData = JSON.parse('{{ browser_stats | tojson }}');
    const osData = JSON.parse('{{ os_stats | tojson }}');
    const countryData = JSON.parse('{{ country_stats | tojson }}');
    const cityData = JSON.parse('{{ city_stats | tojson }}');
    // const locData = JSON.parse('{{ country_city_stats | tojson }}');

    // 1. Daily Traffic Chart (Line)
    new Chart(document.getElementById('dailyTrafficChart'), {
        type: 'line',
        data: {
            labels: Object.keys(dailyTrafficData),
            datasets: [{
                label: 'Sessions',
                data: Object.values(dailyTrafficData),
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                fill: false
            }]
        },
        options: { 
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } 
        }
    });

    // 2. Top Queries Chart (Bar)
    new Chart(document.getElementById('topQueriesChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(topQueriesData),
            datasets: [{
                label: 'Frequency',
                data: Object.values(topQueriesData),
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            maintainAspectRatio: true,
            indexAxis: 'y',
            scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // 3. Search Methods Chart (Bar)
    new Chart(document.getElementById('searchMethodsChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(searchMethodsData),
            datasets: [{
                label: 'Usage',
                data: Object.values(searchMethodsData),
                backgroundColor: 'rgba(255, 159, 64, 0.5)',
                borderColor: 'rgb(255, 159, 64)',
                borderWidth: 1
            }]
        },
        options: {
            maintainAspectRatio: true,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // 4. Browser Chart (Doughnut)
    new Chart(document.getElementById('browserChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(browserData),
            datasets: [{
                data: Object.values(browserData),
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)'
                ]
            }]
        },
        options: {
            maintainAspectRatio: true
        }
    });

    // 4. OS Chart (Pie)
    new Chart(document.getElementById('osChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(osData),
            datasets: [{
                data: Object.values(osData),
                backgroundColor: [
                    'rgb(255, 159, 64)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 99, 132)'
                ]
            }]
        },
        options: {
            maintainAspectRatio: true
        }
    });

    // 4. Country (Pie)
    new Chart(document.getElementById('countryChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(countryData),
            datasets: [{
                data: Object.values(countryData),
                backgroundColor: [
                    'rgb(255, 159, 64)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 99, 132)'
                ]
            }]
        },
        options: {
            maintainAspectRatio: true
        }
    });
    
    // 4. City (Pie)
    new Chart(document.getElementById('cityChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(cityData),
            datasets: [{
                data: Object.values(cityData),
                backgroundColor: [
                    'rgb(255, 159, 64)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 99, 132)'
                ]
            }]
        },
        options: {
            maintainAspectRatio: true
        }
    });

    // var flatNodes = convertTreeToFlatNodes(buildSunburstData(locData));

    // new Chart(document.getElementById('locationSunburst'), {
    //     type: 'sunburst',
    //     data: {
    //         datasets: [{
    //             tree: flatNodes,            // key! must be `tree` for flat nodes
    //             key: 'value',               // property for arc size
    //             nodeId: 'id',               // property in objects
    //             parentId: 'parentId',       // property in objects
    //             backgroundColor: flatNodes.map(n => n.color || 'gray'),
    //             borderWidth: 0.5,
    //             data: flatNodes,                // your flat nodes array
    //         }]
    //     },
    //     options: {
    //         responsive: true,
    //         plugins: {
    //             legend: { display: true },
    //             tooltip: {
    //                 enabled: true,
    //                 callbacks: {
    //                     title: (items) => items[0].raw.name,
    //                     label: (item) => `Sessions: ${item.raw.value}`
    //                 }
    //             }
    //         },
    //         scaleByMetric: 'value'
    //     }
    // });
</script>
{% endblock %}